name: CD - Deploy to ASG

on:
  workflow_run:
    workflows: ["CI - Build and Push Docker Image"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get image tag from triggering workflow
        id: tag
        run: |
          if [[ "${{ github.event.workflow_run.event }}" == "release" ]]; then
            TAG="${{ github.event.workflow_run.head_branch }}"
          else
            TAG=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-8)
          fi
          echo "full_tag=${{ secrets.DOCKER_HUB_USERNAME }}/simple-webpage-cicd-demo:$TAG" >> $GITHUB_OUTPUT

      - name: Generate User Data
        id: userdata
        run: |
          SCRIPT=$(cat <<'EOF'
          #!/bin/bash
          set -e
          exec > /var/log/user-data.log 2>&1
          echo "=== Deployment started: $(date) ==="

          docker pull ${{ steps.tag.outputs.full_tag }}

          docker stop my-app || true
          docker rm my-app || true

          docker run -d \
            --name my-app \
            -p 80:80 \
            --restart unless-stopped \
            ${{ steps.tag.outputs.full_tag }}

          echo "=== Deployment complete: $(date) ==="
          EOF
          )
          # Force Unix line endings (removes any \r)
          SCRIPT=$(echo "$SCRIPT" | tr -d '\r')
          ENCODED=$(echo "$SCRIPT" | base64 -w 0)
          echo "encoded=$ENCODED" >> $GITHUB_OUTPUT

      - name: Create new launch template version
        run: |
          aws ec2 create-launch-template-version \
            --launch-template-id lt-0a04d9971a53a1764 \
            --source-version '$Latest' \
            --launch-template-data "UserData=${{ steps.userdata.outputs.encoded }}"

      - name: Update ASG
        run: |
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name demo-cicd-asg \
            --launch-template LaunchTemplateId=lt-0a04d9971a53a1764,Version='$Latest'

      - name: Start rolling refresh
        run: |
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name demo-cicd-asg \
            --strategy Rolling \
            --preferences '{"MinHealthyPercentage":75,"InstanceWarmup":600}'
